    let messageHistory = JSON.parse(localStorage.getItem('ai_history') || '[]');function escapeHtml(unsafe) { return unsafe .replace(/&/g, "&amp;") .replace(/</g, "&lt;") .replace(/>/g, "&gt;") .replace(/"/g, "&quot;") .replace(/'/g, "&#039;");}function scrollToBottom() { const chat = document.getElementById('ai-chat'); if (chat) { chat.scrollTop = chat.scrollHeight; }}export function render(container) { container.innerHTML = ` <div class="ai-screen"> <div class="ai-chat" id="ai-chat"> <div id="ai-messages" class="ai-messages"> ${messageHistory.map(msg => ` <div class="message ${msg.role}">${escapeHtml(msg.content)}</div> `).join('')} </div> </div> <div class="ai-input-container"> <input type="text" id="ai-question" placeholder="Задай вопрос..."> <button id="ai-send-btn">➡️</button> </div> </div> `; const messagesDiv = document.getElementById('ai-messages'); const input = document.getElementById('ai-question'); const sendBtn = document.getElementById('ai-send-btn'); async function askAI() { const question = input.value.trim(); if (!question) return; messageHistory.push({ role: 'user', content: question }); messagesDiv.innerHTML += ` <div class="message user">${escapeHtml(question)}</div> `; input.value = ''; messagesDiv.innerHTML += `<div class="message bot loading">Думаю...</div>`; scrollToBottom(); try { const data = await window.API.fetch(`${window.CONFIG.API_URL}/api/ai/ask`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ question }) }); document.querySelector('.message.bot.loading')?.remove(); if (data.success) { messageHistory.push({ role: 'bot', content: data.answer }); messagesDiv.innerHTML += ` <div class="message bot">${escapeHtml(data.answer)}</div> `; if (messageHistory.length > 20) { messageHistory = messageHistory.slice(-20); } localStorage.setItem('ai_history', JSON.stringify(messageHistory)); } else { messagesDiv.innerHTML += ` <div class="message bot error">Ошибка: ${escapeHtml(data.error)}</div> `; } } catch (error) { document.querySelector('.message.bot.loading')?.remove(); messagesDiv.innerHTML += ` <div class="message bot error">Ошибка: ${escapeHtml(error.message)}</div> `; } scrollToBottom(); } window.core.addManagedListener(sendBtn, 'click', askAI); window.core.addManagedListener(input, 'keypress', (e) => { if (e.key === 'Enter') askAI(); });}
